<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Management System</title>
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .navbar {
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }
        .navbar-brand {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            background-color: transparent;
        }
        .main-content {
            margin-left: 240px;
            padding: 1.5rem;
        }
        /* Loading Spinner */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            z-index: 9999;
        }
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        /* Alert styles */
        .alert-floating {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Alert Message -->
    <div class="alert-floating alert alert-dismissible fade show" role="alert" id="alertMessage">
        <span id="alertText"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">Form Management System</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="nav-link">
                            <i class="bi bi-person"></i>
                            <span id="currentUser"></span>
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <nav class="col-md-3 col-lg-2 d-md-block sidebar bg-light">
        <div class="position-sticky sidebar-sticky" id="sidebarMenu">
            <!-- Menu items will be dynamically populated -->
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // Utility Functions
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showAlert(message, type = 'success') {
            const alert = document.getElementById('alertMessage');
            alert.className = `alert-floating alert alert-${type} alert-dismissible fade show`;
            document.getElementById('alertText').textContent = message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
        }

        // API Request Helper
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            };

            try {
                showLoading();
                const response = await fetch(endpoint, {
                    ...defaultOptions,
                    ...options,
                    headers: {
                        ...defaultOptions.headers,
                        ...(options.headers || {})
                    }
                });

                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = '/login';
                    return;
                }

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || data.msg || 'API request failed');
                }

                return data;
            } catch (error) {
                showAlert(error.message, 'danger');
                throw error;
            } finally {
                hideLoading();
            }
        }

        // Logout Function
        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        // Initialize Page
        async function initializePage() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const userData = await apiRequest('/api/users/current');
                document.getElementById('currentUser').textContent = userData.username;
                await initializeSidebar(userData.role_id);
            } catch (error) {
                console.error('Error initializing page:', error);
                showAlert('Error loading user data', 'danger');
            }
        }

        // Initialize Sidebar
        async function initializeSidebar(roleId) {
            const menuItems = getMenuItems(roleId);
            const sidebarMenu = document.getElementById('sidebarMenu');
            const currentPath = window.location.pathname;

            const menuHtml = `
                <ul class="nav flex-column">
                    ${menuItems.map(item => `
                        <li class="nav-item">
                            <a class="nav-link ${currentPath === item.path ? 'active' : ''}" href="${item.path}">
                                <i class="bi bi-${item.icon}"></i>
                                ${item.title}
                            </a>
                        </li>
                    `).join('')}
                </ul>
            `;

            sidebarMenu.innerHTML = menuHtml;
        }

        // Menu Configuration
        function getMenuItems(roleId) {
            const menuConfig = {
                1: [ // Admin
                    { title: 'Dashboard', icon: 'speedometer2', path: '/dashboard' },
                    { title: 'Users', icon: 'people', path: '/users' },
                    { title: 'Roles', icon: 'shield', path: '/roles' },
                    { title: 'Forms', icon: 'file-text', path: '/forms' },
                    { title: 'Environments', icon: 'globe', path: '/environments' }
                ],
                2: [ // Site Manager
                    { title: 'Dashboard', icon: 'speedometer2', path: '/dashboard' },
                    { title: 'Forms', icon: 'file-text', path: '/forms' },
                    { title: 'Users', icon: 'people', path: '/users' }
                ],
                3: [ // Supervisor
                    { title: 'Dashboard', icon: 'speedometer2', path: '/dashboard' },
                    { title: 'Forms', icon: 'file-text', path: '/forms' }
                ],
                4: [ // Technician
                    { title: 'Dashboard', icon: 'speedometer2', path: '/dashboard' },
                    { title: 'Forms', icon: 'file-text', path: '/forms' }
                ]
            };

            return menuConfig[roleId] || menuConfig[4];
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>