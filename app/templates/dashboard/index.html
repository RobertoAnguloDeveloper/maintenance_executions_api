{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Dashboard</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshDashboard()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="statsCards">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Forms</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalForms">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-file-text fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Submissions</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalSubmissions">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-inbox fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Recent Activity</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="recentActivity">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-activity fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pending Reviews</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="pendingReviews">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="bi bi-clock-history fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row -->
    <div class="row">
        <!-- Recent Forms -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Forms</h6>
                    <a href="/forms" class="btn btn-sm btn-primary">View All</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="recentFormsTable">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Created By</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Submissions -->
        <div class="col-xl-6 col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Recent Submissions</h6>
                    <a href="/submissions" class="btn btn-sm btn-primary">View All</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="recentSubmissionsTable">
                            <thead>
                                <tr>
                                    <th>Form</th>
                                    <th>Submitted By</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function loadDashboardData() {
        try {
            showLoading();
            // Get current user data
            const userData = await apiRequest('/api/users/current');
            console.log('User data loaded:', userData);
            
            // Load statistics based on user role
            await loadStatistics(userData.role_id);
            
            // Load recent forms and submissions
            await loadRecentForms();
            await loadRecentSubmissions();
        } catch (error) {
            console.error('Error loading dashboard:', error);
            showAlert('Error loading dashboard data', 'danger');
        } finally {
            hideLoading();
        }
    }

    async function loadStatistics(roleId) {
        try {
            const stats = await apiRequest('/api/form_submissions/statistics');
            
            // Update statistics cards
            document.getElementById('totalForms').textContent = stats.total_forms || 0;
            document.getElementById('totalSubmissions').textContent = stats.total_submissions || 0;
            document.getElementById('recentActivity').textContent = stats.recent_activity || 0;
            document.getElementById('pendingReviews').textContent = stats.pending_reviews || 0;
        } catch (error) {
            console.error('Error loading statistics:', error);
            showAlert('Error loading statistics', 'danger');
        }
    }

    async function loadRecentForms() {
        try {
            const forms = await apiRequest('/api/forms?limit=5');
            const tbody = document.querySelector('#recentFormsTable tbody');
            tbody.innerHTML = '';

            forms.forEach(form => {
                tbody.innerHTML += `
                    <tr>
                        <td>${escapeHtml(form.title)}</td>
                        <td>${escapeHtml(form.created_by)}</td>
                        <td>
                            <span class="badge ${form.is_public ? 'bg-success' : 'bg-secondary'}">
                                ${form.is_public ? 'Public' : 'Private'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewForm(${form.id})">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error('Error loading recent forms:', error);
            showAlert('Error loading recent forms', 'danger');
        }
    }

    async function loadRecentSubmissions() {
        try {
            const submissions = await apiRequest('/api/form_submissions?limit=5');
            const tbody = document.querySelector('#recentSubmissionsTable tbody');
            tbody.innerHTML = '';

            submissions.forEach(submission => {
                tbody.innerHTML += `
                    <tr>
                        <td>${escapeHtml(submission.form_title)}</td>
                        <td>${escapeHtml(submission.submitted_by)}</td>
                        <td>${formatDate(submission.submitted_at)}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewSubmission(${submission.id})">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error('Error loading recent submissions:', error);
            showAlert('Error loading recent submissions', 'danger');
        }
    }

    function viewForm(formId) {
        window.location.href = `/forms/${formId}`;
    }

    function viewSubmission(submissionId) {
        window.location.href = `/submissions/${submissionId}`;
    }

    function refreshDashboard() {
        loadDashboardData();
        showAlert('Dashboard refreshed', 'success');
    }

    // Utility functions
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function formatDate(dateString) {
        const options = { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        };
        return new Date(dateString).toLocaleDateString(undefined, options);
    }

    // Load dashboard data when the page loads
    document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>

<style>
    .border-left-primary {
        border-left: 4px solid #4e73df !important;
    }
    .border-left-success {
        border-left: 4px solid #1cc88a !important;
    }
    .border-left-info {
        border-left: 4px solid #36b9cc !important;
    }
    .border-left-warning {
        border-left: 4px solid #f6c23e !important;
    }
    .card-body {
        padding: 1.25rem;
    }
    .text-xs {
        font-size: .7rem;
    }
    .table-hover tbody tr:hover {
        background-color: rgba(0,0,0,.075);
    }
</style>
{% endblock %}